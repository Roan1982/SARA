{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-plug me-2"></i>Integraciones Externas</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevaIntegracionModal">
                    <i class="fas fa-plus me-2"></i>Nueva Integración
                </button>
            </div>

            <!-- Estadísticas -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-primary">{{ integraciones_activas|length }}</h5>
                            <p class="card-text">Integraciones activas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success">{{ sincronizaciones_exitosas }}</h5>
                            <p class="card-text">Sincronizaciones exitosas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning">{{ sincronizaciones_pendientes }}</h5>
                            <p class="card-text">Pendientes</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-info">{{ tipos_integracion|length }}</h5>
                            <p class="card-text">Tipos de integración</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de integraciones -->
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Endpoint</th>
                            <th>Estado</th>
                            <th>Última sincronización</th>
                            <th>Creada por</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for integracion in integraciones %}
                        <tr>
                            <td>{{ integracion.nombre }}</td>
                            <td>
                                <span class="badge bg-primary">{{ integracion.get_tipo_display }}</span>
                            </td>
                            <td>
                                {% if integracion.url_endpoint %}
                                    <a href="{{ integracion.url_endpoint }}" target="_blank" class="text-truncate" style="max-width: 200px; display: inline-block;">
                                        {{ integracion.url_endpoint }}
                                    </a>
                                {% else %}
                                    <span class="text-muted">No configurado</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if integracion.activa %}
                                    {% if integracion.estado_sincronizacion == 'exitoso' %}
                                        <span class="badge bg-success">Sincronizado</span>
                                    {% elif integracion.estado_sincronizacion == 'error' %}
                                        <span class="badge bg-danger">Error</span>
                                    {% else %}
                                        <span class="badge bg-warning">Pendiente</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-secondary">Inactiva</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if integracion.ultima_sincronizacion %}
                                    {{ integracion.ultima_sincronizacion|date:"d/m/Y H:i" }}
                                {% else %}
                                    <span class="text-muted">Nunca</span>
                                {% endif %}
                            </td>
                            <td>{{ integracion.creada_por.get_full_name|default:integracion.creada_por.username }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-success" onclick="probarIntegracion({{ integracion.id }})">
                                    <i class="fas fa-flask"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="editarIntegracion({{ integracion.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="verLogs({{ integracion.id }})">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="toggleIntegracion({{ integracion.id }}, {{ integracion.activa|lower }})">
                                    {% if integracion.activa %}
                                        <i class="fas fa-pause"></i>
                                    {% else %}
                                        <i class="fas fa-play"></i>
                                    {% endif %}
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="eliminarIntegracion({{ integracion.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">No hay integraciones configuradas</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Integración -->
<div class="modal fade" id="nuevaIntegracionModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nueva Integración Externa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="nuevaIntegracionForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nombre" class="form-label">Nombre de la Integración *</label>
                                <input type="text" class="form-control" id="nombre" name="nombre" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo" class="form-label">Tipo de Integración *</label>
                                <select class="form-select" id="tipo" name="tipo" required onchange="toggleTipoIntegracion()">
                                    {% for tipo, nombre in tipos_integracion_opciones %}
                                    <option value="{{ tipo }}">{{ nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" id="descripcion" name="descripcion" rows="3"></textarea>
                    </div>

                    <div id="configuracionAPI" class="config-section">
                        <h6>Configuración API</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="url_endpoint" class="form-label">URL del Endpoint</label>
                                    <input type="url" class="form-control" id="url_endpoint" name="url_endpoint" placeholder="https://api.ejemplo.com/v1/">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="api_key" class="form-label">API Key</label>
                                    <input type="password" class="form-control" id="api_key" name="api_key" placeholder="Tu API Key">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="headers" class="form-label">Headers adicionales (JSON)</label>
                            <textarea class="form-control" id="headers" name="headers" rows="3" placeholder='{"Authorization": "Bearer token", "Content-Type": "application/json"}'></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="autenticacion" class="form-label">Configuración de Autenticación (JSON)</label>
                            <textarea class="form-control" id="autenticacion" name="autenticacion" rows="3" placeholder='{"type": "oauth2", "client_id": "id", "client_secret": "secret"}'></textarea>
                        </div>
                    </div>

                    <div id="configuracionWebhook" class="config-section" style="display: none;">
                        <h6>Configuración Webhook</h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Los webhooks recibirán datos automáticamente cuando ocurran eventos en sistemas externos.
                        </div>
                        <div class="mb-3">
                            <label for="webhook_url" class="form-label">URL del Webhook</label>
                            <input type="url" class="form-control" id="webhook_url" name="webhook_url" placeholder="https://tu-sistema.com/webhook/">
                        </div>
                    </div>

                    <div id="configuracionDatabase" class="config-section" style="display: none;">
                        <h6>Configuración Base de Datos</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="db_host" class="form-label">Host</label>
                                    <input type="text" class="form-control" id="db_host" name="db_host" placeholder="localhost">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="db_port" class="form-label">Puerto</label>
                                    <input type="number" class="form-control" id="db_port" name="db_port" placeholder="5432">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="db_name" class="form-label">Nombre BD</label>
                                    <input type="text" class="form-control" id="db_name" name="db_name">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="db_user" class="form-label">Usuario</label>
                                    <input type="text" class="form-control" id="db_user" name="db_user">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="db_password" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="db_password" name="db_password">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Integración</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Logs -->
<div class="modal fade" id="logsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Logs de Integración</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="logsContent">
                    <!-- Los logs se cargarán aquí -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
function toggleTipoIntegracion() {
    const tipo = document.getElementById('tipo').value;
    const apiSection = document.getElementById('configuracionAPI');
    const webhookSection = document.getElementById('configuracionWebhook');
    const dbSection = document.getElementById('configuracionDatabase');

    // Ocultar todas las secciones
    [apiSection, webhookSection, dbSection].forEach(section => {
        section.style.display = 'none';
    });

    // Mostrar la sección correspondiente
    if (tipo === 'api') {
        apiSection.style.display = 'block';
    } else if (tipo === 'webhook') {
        webhookSection.style.display = 'block';
    } else if (tipo === 'database') {
        dbSection.style.display = 'block';
    }
}

function probarIntegracion(id) {
    fetch(`/api/integraciones-externas/${id}/probar/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Integración probada exitosamente');
        } else {
            alert('❌ Error en la integración: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error de conexión al probar la integración');
    });
}

function toggleIntegracion(id, actualmenteActiva) {
    const accion = actualmenteActiva ? 'desactivar' : 'activar';
    if (confirm(`¿Está seguro de ${accion} esta integración?`)) {
        fetch(`/api/integraciones-externas/${id}/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (response.ok) location.reload();
        });
    }
}

function editarIntegracion(id) {
    // Implementar edición
    console.log('Editar integración:', id);
}

function verLogs(id) {
    fetch(`/api/integraciones-externas/${id}/logs/`)
    .then(response => response.json())
    .then(data => {
        const modal = new bootstrap.Modal(document.getElementById('logsModal'));
        const content = document.getElementById('logsContent');

        if (data.logs && data.logs.length > 0) {
            content.innerHTML = '<ul class="list-group">' +
                data.logs.map(log => `<li class="list-group-item">${log.timestamp} - ${log.message}</li>`).join('') +
                '</ul>';
        } else {
            content.innerHTML = '<p class="text-muted">No hay logs disponibles</p>';
        }

        modal.show();
    });
}

function eliminarIntegracion(id) {
    if (confirm('¿Está seguro de eliminar esta integración? Esta acción no se puede deshacer.')) {
        fetch(`/api/integraciones-externas/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (response.ok) location.reload();
        });
    }
}

document.getElementById('nuevaIntegracionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    let headers = {};
    let autenticacion = {};

    try {
        const headersText = formData.get('headers');
        if (headersText) headers = JSON.parse(headersText);

        const authText = formData.get('autenticacion');
        if (authText) autenticacion = JSON.parse(authText);
    } catch (error) {
        alert('Error en el formato JSON de configuración');
        return;
    }

    // Preparar configuración según el tipo
    const tipo = formData.get('tipo');
    let urlEndpoint = '';
    let apiKey = '';

    if (tipo === 'api') {
        urlEndpoint = formData.get('url_endpoint');
        apiKey = formData.get('api_key');
    } else if (tipo === 'webhook') {
        urlEndpoint = formData.get('webhook_url');
    } else if (tipo === 'database') {
        // Para base de datos, podríamos construir una URL de conexión
        const host = formData.get('db_host') || 'localhost';
        const port = formData.get('db_port') || '5432';
        const dbName = formData.get('db_name');
        const user = formData.get('db_user');
        const password = formData.get('db_password');

        urlEndpoint = `postgresql://${user}:${password}@${host}:${port}/${dbName}`;
    }

    fetch('/api/integraciones-externas/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            nombre: formData.get('nombre'),
            tipo: tipo,
            descripcion: formData.get('descripcion'),
            url_endpoint: urlEndpoint,
            api_key: apiKey,
            headers: headers,
            autenticacion: autenticacion
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            location.reload();
        } else {
            alert('Error al crear la integración: ' + JSON.stringify(data));
        }
    })
    .catch(error => {
        alert('Error de conexión');
    });
});

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    toggleTipoIntegracion();
});
</script>
{% endblock %}
